# Определение зоны кэширования для GeoServer
proxy_cache_path /var/cache/nginx/geoserver levels=1:2 keys_zone=geoserver_cache:10m max_size=1g inactive=60m;

# Настройка upstream для GeoServer Vector (векторные данные)
upstream geoserver_vector {
    server geoserver-vector:8080;
}

# Настройка upstream для GeoServer ECW (растровые данные)
upstream geoserver_ecw {
    server geoserver-ecw:8080;
}

# Настройка логов для отслеживания маршрутизации запросов
log_format geoserver_routing '$remote_addr - $remote_user [$time_local] '
                           '"$request" $status $body_bytes_sent '
                           '"$http_referer" "$http_user_agent" '
                           'routing=$upstream_addr';

# Настройка сервера по умолчанию
server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # Включение логирования маршрутизации для отладки
    access_log /var/log/nginx/access.log geoserver_routing;
    error_log /var/log/nginx/error.log debug;  # Увеличиваем уровень логирования для отладки

    # Кодировка по умолчанию
    charset utf-8;

    # Обработка запросов к статическим файлам
    location / {
        try_files $uri $uri/ =404;
    }

    # Страница выбора инстанции GeoServer
    location = /geoserver/ {
        alias /usr/share/nginx/html/;
        try_files /geoserver-index.html /index.html =404;
    }

    # Редирект с /geoserver/web/ на страницу выбора инстанции
    location = /geoserver/web/ {
        return 302 /geoserver/;
    }

    # ===== VECTOR GEOSERVER CONFIGURATION =====
    # Обработка запросов к веб-интерфейсу GeoServer Vector
    location = /geoserver/vector/web/ {
        alias /usr/share/nginx/html/geoserver/vector/;
        try_files /web.html =404;
    }

    # Обработка запросов к GeoServer Vector (все запросы, кроме специальных)
    location /geoserver/vector/ {
        proxy_pass http://geoserver_vector/geoserver/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 90;
        
        # Настройка перенаправлений
        proxy_redirect ~^/geoserver/(.*)$ /geoserver/vector/$1;
        
        # Добавляем заголовок для идентификации инстанции
        add_header X-GeoServer-Instance "vector" always;
    }

    # Обработка WMS запросов для Vector GeoServer
    location /geoserver/vector/wms {
        proxy_pass http://geoserver_vector/geoserver/wms;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Добавляем заголовок для идентификации инстанции
        add_header X-GeoServer-Instance "vector" always;
        
        # Настройки кэширования
        proxy_cache geoserver_cache;
        proxy_cache_key $request_uri;
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404 1m;
        add_header X-Cache-Status $upstream_cache_status;
        
        # Настройки буферизации
        proxy_buffers 16 4k;
        proxy_buffer_size 2k;
        proxy_max_temp_file_size 1024m;
        proxy_busy_buffers_size 8k;
    }

    # Обработка WFS запросов для Vector GeoServer
    location /geoserver/vector/wfs {
        proxy_pass http://geoserver_vector/geoserver/wfs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Добавляем заголовок для идентификации инстанции
        add_header X-GeoServer-Instance "vector" always;
    }

    # ===== ECW GEOSERVER CONFIGURATION =====
    # Обработка запросов к веб-интерфейсу GeoServer ECW
    location = /geoserver/ecw/web/ {
        alias /usr/share/nginx/html/geoserver/ecw/;
        try_files /web.html =404;
    }
    
    # Обработка запросов к GeoServer ECW (все запросы, кроме специальных)
    location /geoserver/ecw/ {
        proxy_pass http://geoserver_ecw/geoserver/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 90;
        
        # Настройка перенаправлений
        proxy_redirect ~^/geoserver/(.*)$ /geoserver/ecw/$1;
        
        # Добавляем заголовок для идентификации инстанции
        add_header X-GeoServer-Instance "ecw" always;
    }

    # Обработка WMS запросов для ECW GeoServer
    location /geoserver/ecw/wms {
        proxy_pass http://geoserver_ecw/geoserver/wms;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Добавляем заголовок для идентификации инстанции
        add_header X-GeoServer-Instance "ecw" always;
        
        # Настройки кэширования
        proxy_cache geoserver_cache;
        proxy_cache_key $request_uri;
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404 1m;
        add_header X-Cache-Status $upstream_cache_status;
        
        # Настройки буферизации
        proxy_buffers 16 4k;
        proxy_buffer_size 2k;
        proxy_max_temp_file_size 1024m;
        proxy_busy_buffers_size 8k;
    }

    # Обработка WCS запросов для ECW GeoServer
    location /geoserver/ecw/wcs {
        proxy_pass http://geoserver_ecw/geoserver/wcs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Добавляем заголовок для идентификации инстанции
        add_header X-GeoServer-Instance "ecw" always;
    }

    # ===== COMMON CONFIGURATION =====
    # Проверка здоровья сервера
    location /health {
        access_log off;
        return 200 "OK";
    }

    # ===== DJANGO ADMIN PANEL CONFIGURATION =====
    # Проксирование запросов к Django-приложению
    location /admin/ {
        proxy_pass http://gis-admin:8000/admin/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 90;
    }

    # Проксирование запросов к API Django-приложения
    location /api/ {
        proxy_pass http://gis-admin:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 90;
    }

    # Проксирование запросов к статическим файлам Django-приложения
    location /static/ {
        proxy_pass http://gis-admin:8000/static/;
        proxy_set_header Host $host;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # Обработка статических файлов
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # Обработка ошибок
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
