<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Просмотр растрового слоя - 2020-2021</title>
    <!-- Локальная версия OpenLayers CSS -->
    <link rel="stylesheet" href="js/ol.css" type="text/css">
    <!-- Локальная версия OpenLayers JS -->
    <script src="js/ol.js"></script>
    <!-- Добавляем jQuery для упрощения обработки AJAX и других задач -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        .map-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .map-title {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            font-family: Arial, sans-serif;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .layer-switcher {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        .layer-switcher h4 {
            margin-top: 15px;
            margin-bottom: 5px;
        }
        .layer-switcher label {
            display: block;
            margin-bottom: 5px;
        }
        .status-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 4px;
            z-index: 1000;
            font-family: Arial, sans-serif;
            max-width: 400px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .status-panel h3 {
            margin-top: 0;
        }
        /* Добавляем индикатор загрузки */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 10px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="map-container">
        <div class="map-title">
            <h2>Просмотр растрового слоя: 2020-2021</h2>
        </div>
        <div id="map"></div>
        <div class="layer-switcher">
            <h4>Базовые слои</h4>
            <label>
                <input type="radio" name="baselayer" value="osm" checked> OpenStreetMap
            </label>
            <label>
                <input type="radio" name="baselayer" value="google"> Google Maps (Спутник)
            </label>
            <label>
                <input type="radio" name="baselayer" value="googleroads"> Google Maps (Дороги)
            </label>
            <label>
                <input type="radio" name="baselayer" value="yandex"> Яндекс Карты
            </label>
            <label>
                <input type="radio" name="baselayer" value="esri"> ESRI World Imagery
            </label>
            <label>
                <input type="radio" name="baselayer" value="esri_topo"> ESRI Topographic
            </label>
            <label>
                <input type="radio" name="baselayer" value="none"> Без базового слоя
            </label>
            <h4>Растровые слои</h4>
            <label>
                <input type="checkbox" id="raster-layer" checked> 2020-2021 (ECW)
            </label>
            
            <h4>Векторные слои</h4>
            <div class="vector-layers">
                <!-- Динамический список векторных слоев с сервера -->
                <div id="wfs-layers"></div>
                
                <!-- Загрузка локальных файлов -->
                <div class="file-upload">
                    <p>Загрузить локальный файл:</p>
                    <input type="file" id="vector-file-input" accept=".geojson,.kml,.csv,.gpx">
                    <button id="load-vector-file" class="btn-small">Загрузить</button>
                </div>
            </div>
            
            <!-- Управление стилем векторного слоя -->
            <div id="vector-style-panel" style="display: none;">
                <h4>Настройка стиля</h4>
                <label>
                    Цвет линии:
                    <input type="color" id="stroke-color" value="#3399CC">
                </label>
                <label>
                    Толщина линии:
                    <input type="range" id="stroke-width" min="1" max="10" value="2">
                </label>
                <label>
                    Цвет заливки:
                    <input type="color" id="fill-color" value="#FFFFFF">
                </label>
                <label>
                    Прозрачность:
                    <input type="range" id="opacity" min="0" max="100" value="50">
                </label>
                <button id="apply-style" class="btn-small">Применить</button>
            </div>
        </div>
        <div class="status-panel">
            <h3>Статус загрузки</h3>
            <div id="status-message">Загрузка карты...</div>
            <div class="loader" id="loader"></div>
            <div id="error-message" style="color: red;"></div>
        </div>
    </div>

    <script>
        // Добавляем проверку загрузки OpenLayers
        window.addEventListener('load', function() {
            // Выводим информацию о доступности OpenLayers
            var statusMessage = document.getElementById('status-message');
            var errorMessage = document.getElementById('error-message');
            var loader = document.getElementById('loader');
            
            // Показываем индикатор загрузки
            loader.style.display = 'block';
            
            if (typeof ol === 'undefined') {
                errorMessage.innerHTML = 'Ошибка: Библиотека OpenLayers не загружена! Проверьте консоль для деталей.';
                console.error('OpenLayers не определен! Проверьте файл js/ol.js');
                // Добавляем информацию о браузере и проверяем доступность файла
                console.log('User Agent: ' + navigator.userAgent);
                $.ajax({
                    url: 'js/ol.js',
                    type: 'HEAD',
                    success: function() {
                        console.log('Файл js/ol.js доступен, но не загружен правильно');
                    },
                    error: function(xhr, status, error) {
                        console.error('Ошибка доступа к js/ol.js: ' + status + ' - ' + error);
                    }
                });
                loader.style.display = 'none';
                return;
            }
            
            console.log('OpenLayers успешно загружен, версия:', ol.VERSION || 'неизвестна');
            statusMessage.innerHTML = 'OpenLayers загружен успешно. Инициализация карты...';
            
            try {
                // Создание источника для растрового слоя WMS
                var rasterSource = new ol.source.TileWMS({
                    url: 'http://localhost/geoserver/ecw/wms',
                    params: {
                        'LAYERS': 'TEST:2020-2021',
                        'TILED': true,
                        'FORMAT': 'image/png'
                    },
                    serverType: 'geoserver',
                    crossOrigin: 'anonymous'
                });

                // Обработка ошибок загрузки тайлов
                rasterSource.on('tileloaderror', function(e) {
                    console.error('Ошибка загрузки тайла:', e);
                    errorMessage.innerHTML = 'Ошибка загрузки данных слоя. Проверьте, что слой "TEST:2020-2021" существует в GeoServer ECW.';
                    loader.style.display = 'none';
                });

                rasterSource.on('tileloadend', function() {
                    statusMessage.innerHTML = 'Данные загружены успешно.';
                    loader.style.display = 'none';
                });

                // Создание растрового слоя
                var rasterLayer = new ol.layer.Tile({
                    source: rasterSource,
                    title: '2020-2021',
                    visible: true
                });

                // Базовые слои
                // OpenStreetMap
                var osmLayer = new ol.layer.Tile({
                    source: new ol.source.OSM(),
                    title: 'OpenStreetMap',
                    visible: true
                });
                
                // Google Maps (Спутник)
                var googleSatLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
                        attributions: '&copy; Google Maps'
                    }),
                    title: 'Google Satellite',
                    visible: false
                });
                
                // Google Maps (Дороги)
                var googleRoadLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',
                        attributions: '&copy; Google Maps'
                    }),
                    title: 'Google Roads',
                    visible: false
                });
                
                // Яндекс Карты
                var yandexLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://core-renderer-tiles.maps.yandex.net/tiles?l=map&v=21.11.13-0&x={x}&y={y}&z={z}&scale=1&lang=ru_RU',
                        attributions: '&copy; Яндекс'
                    }),
                    title: 'Yandex Maps',
                    visible: false
                });
                
                // ESRI World Imagery
                var esriLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                        attributions: '&copy; ESRI'
                    }),
                    title: 'ESRI World Imagery',
                    visible: false
                });
                
                // ESRI Topographic
                var esriTopoLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
                        attributions: '&copy; ESRI'
                    }),
                    title: 'ESRI Topographic',
                    visible: false
                });

                // Массив всех базовых слоев для удобного управления
                var baseLayers = {
                    'osm': osmLayer,
                    'google': googleSatLayer,
                    'googleroads': googleRoadLayer,
                    'yandex': yandexLayer,
                    'esri': esriLayer,
                    'esri_topo': esriTopoLayer
                };

                // Создание карты
                var map = new ol.Map({
                    target: 'map',
                    layers: [
                        osmLayer, 
                        googleSatLayer, 
                        googleRoadLayer, 
                        yandexLayer, 
                        esriLayer, 
                        esriTopoLayer, 
                        rasterLayer
                    ],
                    view: new ol.View({
                        // Примерный центр России
                        center: ol.proj.fromLonLat([95, 65]),
                        zoom: 3
                    })
                });

                // Добавление элементов управления
                map.addControl(new ol.control.ScaleLine());
                map.addControl(new ol.control.FullScreen());
                map.addControl(new ol.control.Zoom());

                // Обработчики событий для переключателей слоев
                document.querySelectorAll('input[name="baselayer"]').forEach(function(radio) {
                    radio.addEventListener('change', function() {
                        // Скрываем все базовые слои
                        Object.keys(baseLayers).forEach(function(key) {
                            baseLayers[key].setVisible(false);
                        });
                        
                        // Показываем выбранный слой, если он не "none"
                        if (this.value !== 'none' && baseLayers[this.value]) {
                            baseLayers[this.value].setVisible(true);
                        }
                    });
                });

                document.getElementById('raster-layer').addEventListener('change', function() {
                    rasterLayer.setVisible(this.checked);
                });

                // Обновляем статус
                statusMessage.innerHTML = 'Карта загружена, ожидание данных слоя...';
                
                // Добавляем информацию о слое для отладки
                console.log('Информация о слое:', {
                    url: 'http://localhost/geoserver/ecw/wms',
                    layers: 'TEST:2020-2021',
                    projection: 'EPSG:4326'
                });
                
                // Проверка доступности сервиса WMS
                $.ajax({
                    url: 'http://localhost/geoserver/ecw/wms?service=WMS&version=1.1.0&request=GetCapabilities',
                    success: function(data) {
                        console.log('WMS сервис доступен');
                    },
                    error: function(xhr, status, error) {
                        console.error('Ошибка доступа к WMS сервису: ' + status + ' - ' + error);
                        errorMessage.innerHTML = 'Ошибка доступа к WMS сервису: ' + error;
                        loader.style.display = 'none';
                    }
                });

            } catch (e) {
                if (document.getElementById('error-message')) {
                    document.getElementById('error-message').innerHTML = 'Ошибка инициализации карты: ' + e.message;
                }
                console.error('Ошибка инициализации карты:', e);
                loader.style.display = 'none';
            }
        });

        // Инициализация карты после загрузки страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Словарь для хранения базовых слоев (для переключения)
            var baseLayers = {
                'osm': osmLayer,
                'google': googleSatLayer,
                'google-road': googleRoadLayer,
                'yandex': yandexLayer,
                'esri': esriLayer,
                'esri-topo': esriTopoLayer
            };

            // Словарь для хранения векторных слоев
            var vectorLayers = {};
            
            // Функция для запроса доступных векторных слоев через WFS
            function loadAvailableVectorLayers() {
                $.ajax({
                    url: 'http://localhost/geoserver/vector/wfs?service=WFS&version=1.1.0&request=GetCapabilities',
                    method: 'GET',
                    success: function(response) {
                        var capabilitiesXML = response;
                        // Обрабатываем XML ответ от GeoServer
                        var featureTypes = capabilitiesXML.getElementsByTagName('FeatureType');
                        var wfsLayersDiv = document.getElementById('wfs-layers');
                        wfsLayersDiv.innerHTML = '<p>Доступные слои WFS:</p>';
                        
                        if (featureTypes.length === 0) {
                            wfsLayersDiv.innerHTML += '<p>Векторные слои не найдены.</p>';
                            return;
                        }
                        
                        for (var i = 0; i < featureTypes.length; i++) {
                            var nameElement = featureTypes[i].getElementsByTagName('Name')[0];
                            if (nameElement) {
                                var layerName = nameElement.textContent;
                                var titleElement = featureTypes[i].getElementsByTagName('Title')[0];
                                var layerTitle = titleElement ? titleElement.textContent : layerName;
                                
                                // Создаем чекбокс для каждого слоя
                                var checkbox = document.createElement('label');
                                checkbox.innerHTML = 
                                    '<input type="checkbox" class="wfs-layer-checkbox" data-layer="' + 
                                    layerName + '"> ' + layerTitle;
                                wfsLayersDiv.appendChild(checkbox);
                                wfsLayersDiv.appendChild(document.createElement('br'));
                            }
                        }
                        
                        // Добавляем обработчики событий для чекбоксов
                        var checkboxes = document.querySelectorAll('.wfs-layer-checkbox');
                        checkboxes.forEach(function(checkbox) {
                            checkbox.addEventListener('change', function() {
                                var layerName = this.getAttribute('data-layer');
                                if (this.checked) {
                                    addWFSLayer(layerName);
                                } else {
                                    removeVectorLayer(layerName);
                                }
                            });
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Ошибка получения векторных слоев WFS:', error);
                        var wfsLayersDiv = document.getElementById('wfs-layers');
                        wfsLayersDiv.innerHTML = '<p>Ошибка получения векторных слоев. Возможно, WFS-сервис недоступен.</p>';
                    }
                });
            }
            
            // Функция для добавления WFS слоя
            function addWFSLayer(layerName) {
                // Создаем источник данных для WFS
                var vectorSource = new ol.source.Vector({
                    format: new ol.format.GeoJSON(),
                    url: function(extent) {
                        return 'http://localhost/geoserver/vector/wfs?service=WFS&' +
                            'version=1.1.0&request=GetFeature&typename=' + layerName +
                            '&outputFormat=application/json' +
                            '&srsname=EPSG:3857&' +
                            'bbox=' + extent.join(',') + ',EPSG:3857';
                    },
                    strategy: ol.loadingstrategy.bbox
                });
                
                // Создаем слой
                var vectorLayer = new ol.layer.Vector({
                    source: vectorSource,
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: '#3399CC',
                            width: 2
                        }),
                        fill: new ol.style.Fill({
                            color: 'rgba(255, 255, 255, 0.5)'
                        })
                    })
                });
                
                // Добавляем слой на карту
                map.addLayer(vectorLayer);
                vectorLayers[layerName] = vectorLayer;
                
                // Показываем панель стилей
                document.getElementById('vector-style-panel').style.display = 'block';
                
                // Загружаем и зуммируем к границам слоя
                zoomToVectorLayer(layerName);
            }
            
            // Функция для удаления векторного слоя
            function removeVectorLayer(layerName) {
                if (vectorLayers[layerName]) {
                    map.removeLayer(vectorLayers[layerName]);
                    delete vectorLayers[layerName];
                }
                
                // Скрываем панель стилей, если нет активных векторных слоев
                if (Object.keys(vectorLayers).length === 0) {
                    document.getElementById('vector-style-panel').style.display = 'none';
                }
            }
            
            // Функция для зуммирования к границам векторного слоя
            function zoomToVectorLayer(layerName) {
                $.ajax({
                    url: 'http://localhost/geoserver/vector/wfs?service=WFS&version=1.1.0&request=GetFeature&typename=' + 
                         layerName + '&outputFormat=application/json&maxFeatures=1',
                    method: 'GET',
                    success: function(response) {
                        if (response.features && response.features.length > 0) {
                            // Запрашиваем границы слоя
                            $.ajax({
                                url: 'http://localhost/geoserver/vector/wms?service=WMS&version=1.1.0&request=GetCapabilities',
                                method: 'GET',
                                success: function(xml) {
                                    // Ищем информацию о границах слоя в ответе GetCapabilities
                                    $(xml).find('Layer').each(function() {
                                        var name = $(this).find('Name').text();
                                        if (name === layerName) {
                                            var bbox = $(this).find('BoundingBox[SRS="EPSG:3857"]');
                                            if (bbox.length > 0) {
                                                var minx = parseFloat(bbox.attr('minx'));
                                                var miny = parseFloat(bbox.attr('miny'));
                                                var maxx = parseFloat(bbox.attr('maxx'));
                                                var maxy = parseFloat(bbox.attr('maxy'));
                                                
                                                var extent = [minx, miny, maxx, maxy];
                                                map.getView().fit(extent, {
                                                    padding: [50, 50, 50, 50],
                                                    duration: 1000
                                                });
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    }
                });
            }
            
            // Обработчик загрузки локальных векторных файлов
            document.getElementById('load-vector-file').addEventListener('click', function() {
                var fileInput = document.getElementById('vector-file-input');
                var file = fileInput.files[0];
                
                if (!file) {
                    alert('Выберите файл для загрузки.');
                    return;
                }
                
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var format;
                        var fileName = file.name;
                        
                        // Определяем формат файла по расширению
                        if (fileName.endsWith('.geojson') || fileName.endsWith('.json')) {
                            format = new ol.format.GeoJSON();
                        } else if (fileName.endsWith('.kml')) {
                            format = new ol.format.KML();
                        } else if (fileName.endsWith('.gpx')) {
                            format = new ol.format.GPX();
                        } else if (fileName.endsWith('.csv')) {
                            // Для CSV нужна специальная обработка, здесь показан упрощенный вариант
                            // Предполагаем, что CSV имеет столбцы lon,lat или x,y
                            var csvData = e.target.result;
                            var lines = csvData.split('\n');
                            var header = lines[0].split(',');
                            
                            // Ищем индексы столбцов с координатами
                            var lonIndex = header.indexOf('lon');
                            if (lonIndex === -1) lonIndex = header.indexOf('x');
                            
                            var latIndex = header.indexOf('lat');
                            if (latIndex === -1) latIndex = header.indexOf('y');
                            
                            if (lonIndex === -1 || latIndex === -1) {
                                alert('CSV файл должен содержать столбцы lon,lat или x,y');
                                return;
                            }
                            
                            // Создаем GeoJSON из CSV
                            var features = [];
                            for (var i = 1; i < lines.length; i++) {
                                if (lines[i].trim() === '') continue;
                                
                                var values = lines[i].split(',');
                                var lon = parseFloat(values[lonIndex]);
                                var lat = parseFloat(values[latIndex]);
                                
                                if (!isNaN(lon) && !isNaN(lat)) {
                                    var feature = new ol.Feature({
                                        geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat]))
                                    });
                                    features.push(feature);
                                }
                            }
                            
                            addLocalVectorLayer(fileName, features);
                            return;
                        } else {
                            alert('Неподдерживаемый формат файла. Поддерживаются: GeoJSON, KML, CSV, GPX');
                            return;
                        }
                        
                        // Преобразуем данные файла в объекты OpenLayers
                        var features = format.readFeatures(e.target.result, {
                            dataProjection: 'EPSG:4326',
                            featureProjection: 'EPSG:3857'
                        });
                        
                        addLocalVectorLayer(fileName, features);
                    } catch (error) {
                        console.error('Ошибка при чтении файла:', error);
                        alert('Ошибка при чтении файла: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    console.error('Ошибка чтения файла');
                    alert('Ошибка чтения файла');
                };
                
                // Чтение содержимого файла
                reader.readAsText(file);
            });
            
            // Функция для добавления локального векторного слоя
            function addLocalVectorLayer(layerName, features) {
                // Создаем источник данных
                var vectorSource = new ol.source.Vector({
                    features: features
                });
                
                // Создаем слой
                var vectorLayer = new ol.layer.Vector({
                    source: vectorSource,
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: '#3399CC',
                            width: 2
                        }),
                        fill: new ol.style.Fill({
                            color: 'rgba(255, 255, 255, 0.5)'
                        }),
                        image: new ol.style.Circle({
                            radius: 5,
                            stroke: new ol.style.Stroke({
                                color: '#3399CC',
                                width: 2
                            }),
                            fill: new ol.style.Fill({
                                color: 'rgba(255, 255, 255, 0.5)'
                            })
                        })
                    })
                });
                
                // Добавляем слой на карту
                map.addLayer(vectorLayer);
                vectorLayers[layerName] = vectorLayer;
                
                // Показываем панель стилей
                document.getElementById('vector-style-panel').style.display = 'block';
                
                // Зуммируем к границам слоя
                var extent = vectorSource.getExtent();
                map.getView().fit(extent, {
                    padding: [50, 50, 50, 50],
                    duration: 1000
                });
                
                // Добавляем запись в список слоев
                var wfsLayersDiv = document.getElementById('wfs-layers');
                var localLayerDiv = document.createElement('div');
                localLayerDiv.className = 'local-layer';
                localLayerDiv.innerHTML = 
                    '<label><input type="checkbox" class="local-layer-checkbox" data-layer="' + 
                    layerName + '" checked> ' + layerName + ' (локальный)</label>' +
                    '<button class="btn-small remove-layer" data-layer="' + layerName + '">Удалить</button>';
                wfsLayersDiv.appendChild(localLayerDiv);
                
                // Добавляем обработчик для чекбокса
                var checkbox = localLayerDiv.querySelector('.local-layer-checkbox');
                checkbox.addEventListener('change', function() {
                    var layerName = this.getAttribute('data-layer');
                    vectorLayers[layerName].setVisible(this.checked);
                });
                
                // Добавляем обработчик для кнопки удаления
                var removeButton = localLayerDiv.querySelector('.remove-layer');
                removeButton.addEventListener('click', function() {
                    var layerName = this.getAttribute('data-layer');
                    removeVectorLayer(layerName);
                    localLayerDiv.remove();
                });
            }
            
            // Обработчики для изменения стилей
            document.getElementById('apply-style').addEventListener('click', function() {
                var strokeColor = document.getElementById('stroke-color').value;
                var strokeWidth = parseInt(document.getElementById('stroke-width').value);
                var fillColor = document.getElementById('fill-color').value;
                var opacity = parseInt(document.getElementById('opacity').value) / 100;
                
                // Преобразуем цвет заливки с учетом прозрачности
                var rgbaFill = hexToRgba(fillColor, opacity);
                
                // Применяем стиль ко всем видимым векторным слоям
                Object.keys(vectorLayers).forEach(function(layerName) {
                    var layer = vectorLayers[layerName];
                    if (layer.getVisible()) {
                        layer.setStyle(new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: strokeColor,
                                width: strokeWidth
                            }),
                            fill: new ol.style.Fill({
                                color: rgbaFill
                            }),
                            image: new ol.style.Circle({
                                radius: 5,
                                stroke: new ol.style.Stroke({
                                    color: strokeColor,
                                    width: strokeWidth
                                }),
                                fill: new ol.style.Fill({
                                    color: rgbaFill
                                })
                            })
                        }));
                    }
                });
            });
            
            // Функция для преобразования HEX в RGBA
            function hexToRgba(hex, alpha) {
                var r = parseInt(hex.slice(1, 3), 16);
                var g = parseInt(hex.slice(3, 5), 16);
                var b = parseInt(hex.slice(5, 7), 16);
                return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
            }
            
            // Загрузка доступных векторных слоев
            loadAvailableVectorLayers();
            
            // Добавляем дополнительные стили для новых элементов
            var style = document.createElement('style');
            style.textContent = `
                .vector-layers {
                    margin-bottom: 15px;
                }
                .file-upload {
                    margin-top: 10px;
                    border-top: 1px solid #ddd;
                    padding-top: 10px;
                }
                .btn-small {
                    padding: 2px 5px;
                    font-size: 12px;
                    margin-top: 5px;
                }
                #vector-style-panel {
                    background: #f9f9f9;
                    border: 1px solid #ddd;
                    padding: 10px;
                    margin-top: 10px;
                    border-radius: 4px;
                }
                #vector-style-panel label {
                    display: block;
                    margin-bottom: 5px;
                }
                .local-layer {
                    margin-top: 5px;
                    padding: 5px;
                    background: #f0f0f0;
                    border-radius: 3px;
                }
                .remove-layer {
                    margin-left: 10px;
                    background: #f44336;
                    color: white;
                    border: none;
                    border-radius: 3px;
                    cursor: pointer;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html> 