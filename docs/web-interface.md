# Веб-интерфейс ГИС-платформы

## Обзор

Веб-интерфейс корпоративной ГИС-платформы представляет собой интерактивное приложение для визуализации и работы с геопространственными данными. Интерфейс построен на основе библиотеки OpenLayers и обеспечивает доступ к векторным и растровым слоям, публикуемым через GeoServer.

## Структура файлов

```
src/web-interface/
├── css/                # Директория со стилями
│   └── main.css        # Основной файл стилей
├── js/                 # Директория с JavaScript файлами
│   ├── map.js          # Основной скрипт карты
│   └── layer-info.js   # Функции для работы с информацией о слоях
└── index.html          # Главная HTML страница
```

## Компоненты интерфейса

### HTML-структура (index.html)

Основной файл `index.html` содержит базовую структуру веб-интерфейса:

1. **Заголовок (header)** - Содержит название платформы и элементы управления, включая переключатель темы.
2. **Контейнер карты** - Основной элемент для отображения карты.
3. **Панель управления слоями** - Боковая панель для включения/выключения слоев и управления их видимостью.
4. **Элементы управления картой** - Кнопки масштабирования, возврата к исходному положению и инструменты для работы с картой.
5. **Всплывающие окна** - Панели для отображения информации о слоях и объектах.
6. **Футер** - Нижняя часть страницы с информацией об авторских правах.

### Стили (main.css)

Файл `main.css` содержит стили для всех элементов интерфейса:

1. **Основные стили** - Базовое форматирование страницы и элементов.
2. **Стили карты** - Оформление контейнера карты и элементов управления.
3. **Стили панели слоев** - Форматирование боковой панели и элементов управления слоями.
4. **Адаптивные стили** - Правила для корректного отображения на мобильных устройствах.
5. **Темная тема** - Альтернативная цветовая схема для работы в условиях низкой освещенности.
6. **Стили для уведомлений** - Оформление предупреждений и сообщений об ошибках.

### JavaScript-функционал

#### Основной скрипт карты (map.js)

Файл `map.js` отвечает за инициализацию и управление картой:

1. **Инициализация карты** - Создание объекта карты OpenLayers и настройка базовых параметров.
2. **Управление базовыми слоями** - Добавление и переключение между различными базовыми картами (OpenStreetMap, спутниковые снимки, топографическая карта).
3. **Управление растровыми слоями** - Добавление и настройка растровых слоев из GeoServer ECW.
4. **Обработка событий** - Настройка обработчиков для взаимодействия пользователя с картой.
5. **Обработка ошибок** - Механизмы для обнаружения и обработки ошибок загрузки слоев.
6. **Управление темой** - Переключение между светлой и темной темами интерфейса.

#### Функции для работы с информацией о слоях (layer-info.js)

Файл `layer-info.js` содержит функции для получения и отображения информации о слоях:

1. **Получение экстента слоя** - Функция `getLayerExtent()` для определения границ растрового слоя.
2. **Отображение метаданных** - Функция `displayLayerMetadata()` для показа информации о слое.
3. **Получение информации о точке** - Функция `getPointInfo()` для запроса данных о конкретной точке на карте.

## Ключевые функции

### Поддержка растровых слоев

Веб-интерфейс обеспечивает полную поддержку растровых слоев, публикуемых через GeoServer ECW:

```javascript
// Создание слоя с растровыми данными из GeoServer
rasterLayer = new ol.layer.Tile({
    title: 'Растровый слой',
    source: new ol.source.TileWMS({
        url: `${geoserverUrl}/${rasterInstance}/wms`,
        params: {
            'LAYERS': `${workspace}:${layerName}`,
            'TILED': true,
            'FORMAT': 'image/png',
            'VERSION': '1.1.1'
        },
        serverType: 'geoserver',
        crossOrigin: 'anonymous'
    }),
    visible: false
});
```

### Автоматическое определение экстента

Функция `zoomToRasterLayer()` позволяет автоматически определить границы растрового слоя и приблизить к ним карту:

```javascript
function zoomToRasterLayer() {
    // Получаем экстент растрового слоя
    getLayerExtent(workspace, layerName, function(extent) {
        if (extent && map) {
            // Приближаем к экстенту слоя с отступом
            map.getView().fit(extent, {
                padding: [50, 50, 50, 50],
                duration: 1000
            });
        }
    });
}
```

### Переключение базовых слоев

Система поддерживает несколько источников базовых карт с автоматическим переключением при недоступности:

```javascript
function tryNextBaseLayer() {
    // Получаем массив ключей слоев
    const layerKeys = Object.keys(baseLayers);
    
    // Находим индекс текущего активного слоя
    const currentIndex = layerKeys.findIndex(key => baseLayers[key] === activeBaseLayer);
    
    // Пробуем следующий слой
    if (currentIndex !== -1 && layerKeys.length > 1) {
        const nextIndex = (currentIndex + 1) % layerKeys.length;
        const nextLayerKey = layerKeys[nextIndex];
        
        // Деактивируем все слои
        Object.values(baseLayers).forEach(layer => layer.setVisible(false));
        
        // Активируем следующий слой
        baseLayers[nextLayerKey].setVisible(true);
        activeBaseLayer = baseLayers[nextLayerKey];
    }
}
```

### Темная тема

Интерфейс поддерживает полноценную темную тему для всех элементов:

```javascript
// Переключатель темы
const themeSwitch = document.getElementById('theme-switch');
if (themeSwitch) {
    themeSwitch.addEventListener('change', function(e) {
        if (e.target.checked) {
            document.body.classList.add('dark-theme');
        } else {
            document.body.classList.remove('dark-theme');
        }
    });
}
```

### Улучшенная обработка ошибок

Система обеспечивает визуальные индикаторы и уведомления при проблемах с загрузкой слоев:

```javascript
// Обработчик ошибки загрузки тайлов для растрового слоя
const rasterSource = rasterLayer.getSource();
rasterSource.on('tileloaderror', function(event) {
    console.warn('Ошибка загрузки растрового тайла. Возможно слой не опубликован в GeoServer.');
    
    // Проверяем, является ли это первой ошибкой
    if (!window.rasterLayerErrorShown) {
        window.rasterLayerErrorShown = true;
        
        // Выводим предупреждение
        const warningDiv = document.createElement('div');
        warningDiv.className = 'layer-warning';
        warningDiv.innerHTML = `
            <div class="warning-icon">⚠️</div>
            <div class="warning-text">Растровый слой недоступен. Убедитесь, что слой опубликован в GeoServer.</div>
            <button class="warning-close" onclick="this.parentNode.style.display='none';">✕</button>
        `;
        document.body.appendChild(warningDiv);
    }
});
```

## Адаптивный дизайн

Интерфейс адаптирован для корректного отображения на мобильных устройствах:

```css
/* Адаптивные стили */
@media (max-width: 768px) {
    .container {
        flex-direction: column;
    }
    
    .layer-panel {
        width: 100%;
        height: 200px;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .map-controls {
        top: 10px;
    }
}
```

## Использование веб-интерфейса

### Запуск интерфейса

Веб-интерфейс доступен по адресу `http://localhost/` после запуска всех контейнеров:

```powershell
./manage-gis.ps1 start
```

### Работа с растровыми слоями

1. **Включение слоя** - Используйте чекбокс "Растровый слой" в панели управления слоями.
2. **Приближение к слою** - Нажмите кнопку "⎋" рядом с названием слоя для приближения к его границам.
3. **Просмотр информации о слое** - Нажмите кнопку "ℹ" для отображения метаданных слоя.

### Получение информации об объектах

1. Нажмите кнопку "ℹ" в панели управления картой для активации режима получения информации.
2. Кликните по интересующей точке на карте.
3. Информация об объектах в этой точке будет отображена во всплывающем окне.

### Переключение базовых карт

Используйте радиокнопки в разделе "Базовые карты" панели управления слоями для переключения между:
- OpenStreetMap
- Спутниковыми снимками
- Топографической картой

### Использование темной темы

Переключатель темы находится в правом верхнем углу интерфейса. Включение темной темы особенно полезно при работе в условиях низкой освещенности.

## Рекомендации по расширению

### Добавление новых слоев

Для добавления нового слоя в веб-интерфейс:

1. Опубликуйте слой в GeoServer, используя скрипт `setup-raster-layer.ps1` или веб-интерфейс GeoServer.
2. Добавьте новый слой в файл `map.js`:

```javascript
const newLayer = new ol.layer.Tile({
    title: 'Новый слой',
    source: new ol.source.TileWMS({
        url: `${geoserverUrl}/${rasterInstance}/wms`,
        params: {
            'LAYERS': 'workspace:layer_name',
            'TILED': true,
            'FORMAT': 'image/png'
        },
        serverType: 'geoserver',
        crossOrigin: 'anonymous'
    }),
    visible: false
});

// Добавьте слой в карту
map.addLayer(newLayer);

// Обновите панель управления слоями
updateLayerPanel();
```

### Добавление новых инструментов

Для добавления нового инструмента:

1. Добавьте кнопку в HTML:

```html
<button class="map-btn" id="new-tool">🔍</button>
```

2. Добавьте обработчик события в `map.js`:

```javascript
const newToolBtn = document.getElementById('new-tool');
if (newToolBtn) {
    newToolBtn.addEventListener('click', function() {
        // Реализация функциональности инструмента
    });
}
```

## Известные проблемы и решения

### Проблема с загрузкой растровых слоев

**Проблема**: Растровый слой не отображается, в консоли видны ошибки загрузки тайлов.

**Решение**:
1. Убедитесь, что слой правильно опубликован в GeoServer ECW.
2. Проверьте доступность GeoServer по адресу `http://localhost/geoserver/ecw/web/`.
3. Проверьте правильность указания имени рабочего пространства и слоя в файле `map.js`.

### Проблема с отображением базовых карт

**Проблема**: Базовые карты не загружаются.

**Решение**:
1. Проверьте подключение к интернету, так как базовые карты загружаются из внешних источников.
2. Если проблема сохраняется, система автоматически попытается переключиться на другой источник базовых карт.

### Проблема с адаптивностью на мобильных устройствах

**Проблема**: Некорректное отображение интерфейса на мобильных устройствах.

**Решение**:
1. Убедитесь, что в `index.html` присутствует мета-тег для адаптивности:
```html
<meta name="viewport" content="width=device-width, initial-scale=1.0">
```
2. Проверьте наличие адаптивных стилей в `main.css`.

## Заключение

Веб-интерфейс корпоративной ГИС-платформы предоставляет удобный и функциональный инструмент для работы с геопространственными данными. Модульная структура и чистое разделение кода обеспечивают простоту поддержки и расширения функциональности в будущем. 