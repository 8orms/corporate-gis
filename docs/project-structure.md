# Структура проекта Корпоративной ГИС-платформы

## Общая структура

```
corporate-gis/
├── docs/                       # Документация проекта
│   ├── storybook.md            # Журнал разработки и дорожная карта
│   ├── powershell-tools.md     # Документация по инструментам PowerShell
│   └── ...                     # Другие документы
│
├── config/                     # Конфигурационные файлы
│   ├── docker/                 # Конфигурации Docker
│   │   ├── dev/                # Конфигурация для разработки
│   │   │   └── docker-compose.yml  # Docker Compose для разработки
│   │   └── prod/               # Конфигурация для продакшена
│   │       └── docker-compose.yml  # Docker Compose для продакшена
│   │
│   ├── nginx/                  # Конфигурация NGINX
│   │   ├── nginx.conf          # Основной конфигурационный файл с глобальными настройками NGINX
│   │   └── conf.d/             # Директории конфигураций
│   │
│   └── geoserver/             # Конфигурация GeoServer
│       ├── vector/            # Конфигурация для векторного GeoServer
│       └── ecw/               # Конфигурация для растрового GeoServer
│
├── data/                      # Данные проекта (игнорируются Git)
│   ├── postgis/               # Данные PostgreSQL/PostGIS
│   ├── geoserver/             # Данные GeoServer
│   │   ├── vector/data_dir/   # Директория данных для векторного GeoServer
│   │   └── ecw/data_dir/      # Директория данных для растрового GeoServer
│   │
│   ├── raster-storage/        # Хранилище растровых данных
│   │   └── ecw/               # ECW растры
│   │
│   ├── vector-storage/        # Хранилище векторных данных
│   │   ├── shp/               # Шейп-файлы
│   │   └── kml/               # KML/KMZ файлы
│   │
│   └── user-projections/      # Общие пользовательские проекции для всех GeoServer
│       └── epsg.properties    # Файл определений пользовательских проекций
│
├── scripts/                   # Скрипты для автоматизации
│   ├── initialize-project.ps1 # Скрипт инициализации проекта
│   ├── manage-ecw.ps1         # Скрипт для управления ECW файлами
│   ├── setup-projections.ps1  # Скрипт для настройки пользовательских проекций
│   ├── test-environment.ps1   # Скрипт для проверки работоспособности
│   └── ...                    # Другие скрипты
│
├── src/                       # Исходный код
│   ├── web-interface/         # Веб-интерфейс ГИС
│   │   ├── css/               # Стили
│   │   ├── js/                # JavaScript
│   │   └── index.html         # Главная страница
│   │
│   └── services/              # Дополнительные сервисы
│
├── backups/                   # Резервные копии конфигурации
├── .gitignore                 # Игнорируемые файлы Git
├── .cursorrules               # Настройки Cursor AI
├── README.md                  # Основное описание проекта
├── docker-compose.yml         # Корневой Docker Compose
├── manage-gis.ps1             # Главный скрипт управления
└── .env                       # Переменные окружения
```

## Описания директорий

### docs/
Содержит все документы проекта, включая руководства, спецификации и журнал разработки.

### config/
Централизованное место для всех конфигурационных файлов, разделенных по компонентам.

#### config/docker/
Конфигурации Docker для различных сред (разработка, продакшен).

#### config/nginx/
Файлы конфигурации веб-сервера NGINX, включая настройки проксирования для GeoServer.

- **nginx.conf** - Основной конфигурационный файл с глобальными настройками NGINX
- **conf.d/default.conf** - Основной файл конфигурации виртуальных хостов и проксирования
  
> **Примечание**: Используйте только файл `default.conf` для настройки проксирования. Не создавайте файлы с именами `default.conf.bak`, `default.conf.current` или подобные, так как это может привести к путанице при обработке конфигурации.

#### config/geoserver/
Конфигурационные файлы для различных инстанций GeoServer.

### data/
Хранилище данных проекта. Эта директория игнорируется Git, поскольку содержит большие объемы данных.

#### data/postgis/
Хранит файлы базы данных PostgreSQL/PostGIS.

#### data/geoserver/
Данные, непосредственно используемые различными инстанциями GeoServer.

#### data/raster-storage/ и data/vector-storage/
Структурированное хранилище различных типов геопространственных данных.

#### data/user-projections/
Общая директория для пользовательских проекций, подключаемая к обеим инстанциям GeoServer. Содержит файл `epsg.properties` и пользовательские файлы проекций `.prj`.

### scripts/
Скрипты автоматизации для установки, обновления и обслуживания системы.

### src/
Исходный код веб-интерфейса и дополнительных сервисов.

## Архитектура системы

### Две инстанции GeoServer
Система использует две отдельные инстанции GeoServer для разных задач:

1. **GeoServer Vector** (kartoza/geoserver:2.26.1)
   - Новая версия для работы с векторными данными
   - Доступен по адресу: http://localhost/geoserver/vector/
   - Порт: 8080

2. **GeoServer ECW** (urbanits/geoserver)
   - Специальная версия с поддержкой ECW формата для растровых данных
   - Доступен по адресу: http://localhost/geoserver/ecw/
   - Порт: 8081

### Общие пользовательские проекции
Для упрощения управления пользовательскими проекциями используется общая директория `data/user-projections`, которая монтируется в обе инстанции GeoServer как `/opt/geoserver/data_dir/user_projections`.

## Управление системой

Система предоставляет единый интерфейс командной строки для управления через скрипт `manage-gis.ps1`, который поддерживает следующие команды:

```powershell
# Инициализация проекта
./manage-gis.ps1 init [dev|prod]

# Запуск и остановка сервисов
./manage-gis.ps1 start
./manage-gis.ps1 stop
./manage-gis.ps1 restart

# Проверка состояния
./manage-gis.ps1 status
./manage-gis.ps1 test

# Управление данными
./manage-gis.ps1 manage-ecw [list|import|register|move]
./manage-gis.ps1 setup-projections

# Обслуживание
./manage-gis.ps1 logs [service_name]
./manage-gis.ps1 backup
```

## Управление данными

### Управление пользовательскими проекциями
Для работы с пользовательскими проекциями используется директория `data/user-projections`:

1. Для настройки директории пользовательских проекций выполните:
   ```powershell
   ./manage-gis.ps1 setup-projections
   ```

2. Отредактируйте файл `data/user-projections/epsg.properties` для добавления определений проекций
   
3. Поместите файлы проекций (`.prj`) в директорию `data/user-projections`

4. Для применения изменений перезапустите GeoServer:
   ```powershell
   ./manage-gis.ps1 restart
   ```

### Управление ECW файлами
Для работы с ECW файлами используйте команду:
```powershell
# Просмотр списка файлов
./manage-gis.ps1 manage-ecw list

# Импорт ECW файла
./manage-gis.ps1 manage-ecw import -FilePath <путь>

# Регистрация файла проекции
./manage-gis.ps1 manage-ecw register -FilePath <путь>
```

## Обслуживание

### Управление резервными копиями
Для создания резервной копии конфигурации выполните:
```powershell
./manage-gis.ps1 backup
```

Резервные копии сохраняются в директории `backups/`.

### Проверка работоспособности
Для проверки состояния всех компонентов системы выполните:
```powershell
./manage-gis.ps1 test
```

Скрипт проверит статус контейнеров, доступность веб-сервисов и наличие пользовательских проекций. 