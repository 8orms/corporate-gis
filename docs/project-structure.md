# Структура проекта Корпоративной ГИС-платформы

## Общая структура

```
corporate-gis/
├── docs/                       # Документация проекта
│   ├── storybook.md            # Журнал разработки и дорожная карта
│   ├── powershell-tools.md     # Документация по инструментам PowerShell
│   ├── project-structure.md    # Описание структуры проекта
│   └── modernization/          # Документация по модернизации системы
│
├── config/                     # Конфигурационные файлы
│   ├── docker/                 # Конфигурации Docker
│   │   ├── dev/                # Конфигурация для разработки
│   │   │   └── docker-compose.yml  # Docker Compose для разработки
│   │   └── prod/               # Конфигурация для продакшена
│   │       └── docker-compose.yml  # Docker Compose для продакшена
│   │
│   ├── nginx/                  # Конфигурация NGINX
│   │   ├── nginx.conf          # Основной конфигурационный файл с глобальными настройками NGINX
│   │   └── conf.d/             # Директории конфигураций
│   │
│   └── geoserver/             # Конфигурация GeoServer
│       ├── vector/            # Конфигурация для векторного GeoServer
│       └── ecw/               # Конфигурация для растрового GeoServer
│
├── data/                      # Данные проекта (игнорируются Git)
│   ├── postgis/               # Данные PostgreSQL/PostGIS
│   ├── geoserver/             # Данные GeoServer
│   │   ├── vector/data_dir/   # Директория данных для векторного GeoServer
│   │   └── ecw/data_dir/      # Директория данных для растрового GeoServer
│   │
│   ├── raster-storage/        # Хранилище растровых данных
│   │   └── ecw/               # ECW растры
│   │
│   ├── vector-storage/        # Хранилище векторных данных
│   │   ├── shp/               # Шейп-файлы
│   │   └── kml/               # KML/KMZ файлы
│   │
│   └── user-projections/      # Общие пользовательские проекции для всех GeoServer
│       └── epsg.properties    # Файл определений пользовательских проекций
│
├── scripts/                   # Скрипты для автоматизации
│   ├── initialize-project.ps1 # Скрипт инициализации проекта
│   ├── manage-ecw.ps1         # Скрипт для управления ECW файлами
│   ├── setup-projections.ps1  # Скрипт для настройки пользовательских проекций
│   ├── setup-raster-layer.ps1 # Скрипт для публикации растровых слоев
│   ├── test-environment.ps1   # Скрипт для проверки работоспособности
│   └── ...                    # Другие скрипты
│
├── src/                       # Исходный код
│   ├── web-interface/         # Веб-интерфейс ГИС
│   │   ├── css/               # Стили
│   │   │   └── main.css       # Основной файл стилей
│   │   ├── js/                # JavaScript
│   │   │   ├── map.js         # Основной скрипт карты
│   │   │   └── layer-info.js  # Функции для работы с информацией о слоях
│   │   └── index.html         # Главная страница
│   │
│   └── services/              # Дополнительные сервисы
│
├── backups/                   # Резервные копии конфигурации
├── .gitignore                 # Игнорируемые файлы Git
├── .cursorrules               # Настройки Cursor AI
├── README.md                  # Основное описание проекта
├── docker-compose.yml         # Корневой Docker Compose
├── manage-gis.ps1             # Главный скрипт управления
└── .env                       # Переменные окружения
```

## Описания директорий

### docs/
Содержит все документы проекта, включая руководства, спецификации и журнал разработки.

### config/
Централизованное место для всех конфигурационных файлов, разделенных по компонентам.

#### config/docker/
Конфигурации Docker для различных сред (разработка, продакшен).

#### config/nginx/
Файлы конфигурации веб-сервера NGINX, включая настройки проксирования для GeoServer.

- **nginx.conf** - Основной конфигурационный файл с глобальными настройками NGINX
- **conf.d/default.conf** - Основной файл конфигурации виртуальных хостов и проксирования
  
> **Примечание**: Используйте только файл `default.conf` для настройки проксирования. Не создавайте файлы с именами `default.conf.bak`, `default.conf.current` или подобные, так как это может привести к путанице при обработке конфигурации.

#### config/geoserver/
Конфигурационные файлы для различных инстанций GeoServer.

### data/
Хранилище данных проекта. Эта директория игнорируется Git, поскольку содержит большие объемы данных.

#### data/postgis/
Хранит файлы базы данных PostgreSQL/PostGIS.

#### data/geoserver/
Данные, непосредственно используемые различными инстанциями GeoServer.

#### data/raster-storage/ и data/vector-storage/
Структурированное хранилище различных типов геопространственных данных.

#### data/user-projections/
Общая директория для пользовательских проекций, подключаемая к обеим инстанциям GeoServer. Содержит файл `epsg.properties` и пользовательские файлы проекций `.prj`.

### scripts/
Скрипты автоматизации для установки, обновления и обслуживания системы.

#### scripts/setup-raster-layer.ps1
Новый скрипт для публикации растровых слоев в GeoServer. Позволяет автоматизировать процесс создания рабочего пространства, хранилища данных и публикации слоя. Поддерживает различные форматы растровых данных, включая ECW, GeoTIFF, JPEG2000 и другие.

Пример использования:
```powershell
./scripts/setup-raster-layer.ps1 -GeoServerUrl "http://localhost:8081/geoserver/rest" -AdminUser "admin" -AdminPassword "geoserver" -WorkspaceName "raster" -DatastoreName "ecw_store" -LayerName "landsat" -RasterFilePath "D:\data\imagery\landsat.ecw" -CoverageSRS "EPSG:4326"
```

### src/
Исходный код веб-интерфейса и дополнительных сервисов.

#### src/web-interface/
Веб-интерфейс ГИС-платформы, реорганизованный для улучшения поддержки и расширения функциональности:

- **css/main.css** - Основной файл стилей, включающий поддержку темной темы и адаптивный дизайн
- **js/map.js** - Основной скрипт для инициализации и управления картой
- **js/layer-info.js** - Функции для работы с информацией о слоях, включая получение экстента и метаданных
- **index.html** - Главная страница с базовой структурой интерфейса

## Архитектура системы

### Две инстанции GeoServer
Система использует две отдельные инстанции GeoServer для разных задач:

1. **GeoServer Vector** (kartoza/geoserver:2.26.1)
   - Новая версия для работы с векторными данными
   - Доступен по адресу: http://localhost/geoserver/vector/
   - Порт: 8080

2. **GeoServer ECW** (urbanits/geoserver)
   - Специальная версия с поддержкой ECW формата для растровых данных
   - Доступен по адресу: http://localhost/geoserver/ecw/
   - Порт: 8081

⚠️ Никогда не используйте сокращенный URL без указания инстанции: `http://localhost/geoserver/web/`

### Общие пользовательские проекции
Для упрощения управления пользовательскими проекциями используется общая директория `data/user-projections`, которая монтируется в обе инстанции GeoServer как `/opt/geoserver/data_dir/user_projections`.

## Управление системой

Система предоставляет единый интерфейс командной строки для управления через скрипт `manage-gis.ps1`, который поддерживает следующие команды:

```powershell
# Инициализация проекта
./manage-gis.ps1 init [dev|prod]

# Запуск и остановка сервисов
./manage-gis.ps1 start
./manage-gis.ps1 stop
./manage-gis.ps1 restart

# Проверка состояния
./manage-gis.ps1 status
./manage-gis.ps1 test

# Управление данными
./manage-gis.ps1 manage-ecw [list|import|register|move]
./manage-gis.ps1 setup-projections

# Обслуживание
./manage-gis.ps1 logs [service_name]
./manage-gis.ps1 backup
```

## Управление данными

### Управление пользовательскими проекциями
Для работы с пользовательскими проекциями используется директория `data/user-projections`:

1. Для настройки директории пользовательских проекций выполните:
   ```powershell
   ./manage-gis.ps1 setup-projections
   ```

2. Отредактируйте файл `data/user-projections/epsg.properties` для добавления определений проекций
   
3. Поместите файлы проекций (`.prj`) в директорию `data/user-projections`

4. Для применения изменений перезапустите GeoServer:
   ```powershell
   ./manage-gis.ps1 restart
   ```

### Управление ECW файлами
Для работы с ECW файлами используйте команду:
```powershell
# Просмотр списка файлов
./manage-gis.ps1 manage-ecw list

# Импорт ECW файла
./manage-gis.ps1 manage-ecw import -FilePath <путь>

# Регистрация файла проекции
./manage-gis.ps1 manage-ecw register -FilePath <путь>
```

### Публикация растровых слоев
Для публикации растровых слоев в GeoServer ECW используйте новый скрипт:
```powershell
./scripts/setup-raster-layer.ps1 -GeoServerUrl "http://localhost:8081/geoserver/rest" -AdminUser "admin" -AdminPassword "geoserver" -WorkspaceName "raster" -DatastoreName "ecw_store" -LayerName "landsat" -RasterFilePath "D:\data\imagery\landsat.ecw" -CoverageSRS "EPSG:4326"
```

Скрипт автоматически:
1. Создает рабочее пространство, если оно не существует
2. Создает хранилище данных для растрового файла
3. Публикует слой с указанным именем
4. Применяет стиль по умолчанию
5. Проверяет доступность слоя через WMS

## Обслуживание

### Управление резервными копиями
Для создания резервной копии конфигурации выполните:
```powershell
./manage-gis.ps1 backup
```

Резервные копии сохраняются в директории `backups/`.

### Проверка работоспособности
Для проверки состояния всех компонентов системы выполните:
```powershell
./manage-gis.ps1 test
```

Скрипт проверит статус контейнеров, доступность веб-сервисов и наличие пользовательских проекций.

## Веб-интерфейс

Веб-интерфейс ГИС-платформы был реорганизован для улучшения поддержки и расширения функциональности:

### Основные компоненты:
- **index.html** - Основная HTML-страница с разметкой интерфейса
- **css/main.css** - Стили для всех элементов интерфейса, включая поддержку темной темы
- **js/map.js** - Основной скрипт для инициализации и управления картой
- **js/layer-info.js** - Функции для работы с информацией о слоях

### Ключевые функции веб-интерфейса:
1. **Поддержка растровых слоев** - Интеграция с GeoServer ECW для отображения растровых данных
2. **Автоматическое определение экстента** - Функция для приближения к границам растрового слоя
3. **Переключение базовых слоев** - Поддержка нескольких источников базовых карт с автоматическим переключением при недоступности
4. **Темная тема** - Полная поддержка темной темы для всех элементов интерфейса
5. **Улучшенная обработка ошибок** - Визуальные индикаторы и уведомления при проблемах с загрузкой слоев
6. **Адаптивный дизайн** - Корректное отображение на мобильных устройствах

## Планируемая структура для компромиссной модернизации

В рамках компромиссного подхода к модернизации платформы, структура проекта будет дополнена следующими компонентами:

```
.
├── config/                         # Конфигурационные файлы
│   ├── geoserver/                  # Конфигурации GeoServer
│   │   ├── vector/                 # Конфигурация для векторного GeoServer
│   │   └── raster/                 # Конфигурация для растрового GeoServer
│   └── nginx/                      # Конфигурации NGINX
│       ├── nginx.conf              # Основной конфигурационный файл
│       └── conf.d/                 # Дополнительные конфигурации
│           └── default.conf        # Настройки по умолчанию
├── data/                           # Данные для GeoServer
│   ├── vector/                     # Векторные данные
│   └── raster/                     # Растровые данные (включая ECW)
├── scripts/                        # PowerShell скрипты
│   ├── initialize-project.ps1      # Скрипт инициализации проекта
│   ├── manage-ecw.ps1              # Скрипт управления ECW файлами
│   └── utils/                      # Вспомогательные скрипты
├── src/                            # Исходный код
│   └── web-interface/              # Веб-интерфейс проекта
│       ├── css/                    # CSS стили
│       ├── js/                     # JavaScript файлы
│       ├── geoserver/              # Специфичные файлы для GeoServer
│       └── index.html              # Основная HTML страница
├── docs/                           # Документация
├── docker-compose.yml              # Конфигурация Docker Compose
└── manage-gis.ps1                  # Основной скрипт управления
```

### Ключевые изменения в структуре проекта

1. **Добавление административной панели Django**
   - `src/admin-panel/` - Директория с Django-приложением
   - `media/` и `static/` - Директории для медиа и статических файлов Django
   - `config/django/` - Конфигурации для Django

2. **Модернизация веб-интерфейса**
   - `src/web-interface/webgis/` - Новая структура веб-приложения на основе JS-фреймворка
   - Организация кода по принципу компонентов и сервисов

3. **Обновление инфраструктуры**
   - Добавление контейнера Django в `docker-compose.yml`
   - Обновление конфигураций NGINX для проксирования запросов к Django
   - Расширение скриптов управления для поддержки новых компонентов

Эта структура обеспечивает чистую интеграцию новых компонентов, сохраняя при этом совместимость с существующими частями системы. В будущем это позволит постепенно интегрировать дополнительные компоненты GeoNode без необходимости радикальной реорганизации проекта. 