# PowerShell инструменты для управления ГИС-платформой

В этом документе описаны PowerShell скрипты, предназначенные для управления корпоративной ГИС-платформой. Данные инструменты помогают автоматизировать типовые задачи администрирования, такие как инициализация проекта, управление ECW-файлами, мониторинг состояния системы и т.д.

## Основной скрипт управления: `manage-gis.ps1`

Этот скрипт предоставляет единую точку входа для всех операций по управлению ГИС-платформой. Он объединяет функциональность других скриптов и предоставляет удобный интерфейс командной строки.

### Использование

```powershell
./manage-gis.ps1 <команда> [аргументы]
```

### Доступные команды

| Команда | Описание | Примеры использования |
|---------|----------|------------------------|
| `init` | Инициализация проекта с созданием структуры каталогов и конфигурационных файлов | `./manage-gis.ps1 init dev` |
| `start` | Запуск контейнеров Docker | `./manage-gis.ps1 start` |
| `stop` | Остановка контейнеров Docker | `./manage-gis.ps1 stop` |
| `restart` | Перезапуск контейнеров Docker | `./manage-gis.ps1 restart` |
| `status` | Проверка статуса системы и вывод основных параметров | `./manage-gis.ps1 status` |
| `logs` | Просмотр логов контейнеров | `./manage-gis.ps1 logs geoserver-ecw` |
| `backup` | Создание резервной копии конфигурации | `./manage-gis.ps1 backup` |
| `manage-ecw` | Управление ECW файлами и проекциями | `./manage-gis.ps1 manage-ecw list` |
| `help` | Показать справку по командам | `./manage-gis.ps1 help` |

### Примеры использования

Инициализация проекта для разработки:
```powershell
./manage-gis.ps1 init dev
```

Запуск всех контейнеров:
```powershell
./manage-gis.ps1 start
```

Проверка состояния системы:
```powershell
./manage-gis.ps1 status
```

## Скрипт инициализации: `scripts/initialize-project.ps1`

Этот скрипт отвечает за начальную настройку проекта. Он создаёт структуру директорий, базовые конфигурационные файлы, файл `.gitignore`, настройки Docker и NGINX, а также простой веб-интерфейс.

### Использование

```powershell
./scripts/initialize-project.ps1 -Environment <dev|prod> [-Force]
```

### Параметры

- `-Environment <dev|prod>` - Окружение, для которого будет создана конфигурация (по умолчанию: dev)
- `-Force` - Принудительная перезапись существующих файлов

### Что делает скрипт

1. Проверяет наличие Docker, Docker Compose и Git
2. Создаёт структуру директорий для проекта
3. Создаёт файл `.gitignore`
4. Создаёт файлы `.env.example` и `.env`
5. Создаёт конфигурации Docker Compose для разработки и продакшена
6. Создаёт конфигурационные файлы NGINX
7. Создаёт базовый веб-интерфейс на основе OpenLayers

## Управление ECW файлами: `scripts/manage-ecw.ps1`

Этот скрипт предназначен для управления ECW файлами и пользовательскими проекциями, которые часто используются в ГИС-системах.

### Использование

```powershell
./scripts/manage-ecw.ps1 -Action <действие> [параметры]
```

### Доступные действия

| Действие | Описание | Параметры |
|----------|----------|-----------|
| `list` | Показать список ECW файлов и проекций | - |
| `import` | Импортировать ECW файл в директорию хранения | `-FilePath <путь_к_файлу>` |
| `register` | Зарегистрировать файл проекции | `-FilePath <путь_к_файлу>` |
| `move` | Переместить ECW файл внутри хранилища | `-FilePath <путь_к_файлу> -TargetPath <путь_назначения>` |
| `help` | Показать справку | - |

### Параметры скрипта

- `-Action` - Действие, которое нужно выполнить
- `-FilePath` - Путь к исходному файлу
- `-TargetPath` - Путь назначения (для перемещения)
- `-Force` - Принудительная перезапись существующих файлов

### Примеры использования

Просмотр списка ECW файлов и проекций:
```powershell
./scripts/manage-ecw.ps1 -Action list
```

Импорт ECW файла:
```powershell
./scripts/manage-ecw.ps1 -Action import -FilePath D:/maps/city_map.ecw
```

Регистрация файла проекции:
```powershell
./scripts/manage-ecw.ps1 -Action register -FilePath D:/projections/custom.prj
```

Перемещение ECW файла:
```powershell
./scripts/manage-ecw.ps1 -Action move -FilePath data/raster-storage/ecw/old_map.ecw -TargetPath data/raster-storage/ecw/archive/
```

## Проверка здоровья системы: `scripts/check-health.ps1`

Этот скрипт проверяет состояние всех сервисов ГИС-платформы и выводит подробную информацию о работоспособности системы.

### Использование

```powershell
./scripts/check-health.ps1 [-Verbose] [-FixProblems]
```

### Параметры

- `-Verbose` - Вывод более подробной информации
- `-FixProblems` - Попытка автоматического исправления обнаруженных проблем

### Что проверяет скрипт

1. Состояние контейнеров Docker
2. Доступность веб-сервисов через HTTP
3. Подключение к PostGIS
4. Использование дискового пространства
5. Наличие и размер ECW файлов

## Создание структуры директорий: `scripts/create-directories.ps1`

Этот скрипт создаёт базовую структуру директорий для проекта. Он может использоваться как отдельно, так и вызываться из скрипта инициализации.

### Использование

```powershell
./scripts/create-directories.ps1
```

## Рекомендации по использованию

### Начало работы с проектом

1. Выполните инициализацию проекта:
   ```powershell
   ./manage-gis.ps1 init dev
   ```

2. Запустите контейнеры:
   ```powershell
   ./manage-gis.ps1 start
   ```

3. Проверьте статус системы:
   ```powershell
   ./manage-gis.ps1 status
   ```

### Регулярное обслуживание

1. Проверяйте состояние системы:
   ```powershell
   ./manage-gis.ps1 status
   ```

2. Создавайте регулярные резервные копии:
   ```powershell
   ./manage-gis.ps1 backup
   ```

3. При необходимости управляйте ECW файлами:
   ```powershell
   ./manage-gis.ps1 manage-ecw list
   ```

### Устранение неполадок

1. Проверьте логи сервисов:
   ```powershell
   ./manage-gis.ps1 logs
   ```

2. Запустите проверку здоровья с попыткой исправления:
   ```powershell
   ./scripts/check-health.ps1 -FixProblems
   ```

3. Перезапустите проблемные сервисы:
   ```powershell
   ./manage-gis.ps1 restart
   ```

## Интеграция с CI/CD

Описанные инструменты можно интегрировать в процессы непрерывной интеграции и доставки (CI/CD). Для этого можно использовать скрипты в неинтерактивном режиме с предопределёнными параметрами.

Например, для инициализации проекта в CI/CD пайплайне:
```powershell
./scripts/initialize-project.ps1 -Environment prod -Force
```

## Расширение функциональности

Инструменты спроектированы модульно, что позволяет легко добавлять новые функции. Для добавления нового функционала рекомендуется:

1. Создать отдельный скрипт в папке `scripts/`
2. Добавить вызов этого скрипта в общий скрипт управления `manage-gis.ps1`
3. Обновить документацию 

### Сбор и анализ логов контейнеров

Для сбора и анализа логов из всех контейнеров выполните:
```powershell
# Базовое использование
./scripts/collect-container-logs.ps1

# Получение логов за последний час
./scripts/collect-container-logs.ps1 -Since "1h"

# Сбор последних 500 строк с включением информационных сообщений
./scripts/collect-container-logs.ps1 -Lines 500 -IncludeInfo

# Сохранение результатов в указанный файл
./scripts/collect-container-logs.ps1 -OutputFile "logs/debug/containers.log"
```

Скрипт выполняет следующие операции:
1. Получает список всех запущенных контейнеров
2. Собирает логи из каждого контейнера
3. Фильтрует ошибки и предупреждения (опционально - информационные сообщения)
4. Удаляет дубликаты сообщений
5. Группирует сообщения по контейнерам и типам
6. Сохраняет результаты в файл и выводит на экран

Это позволяет быстро выявлять проблемы во всей инфраструктуре, не просматривая логи каждого контейнера в отдельности. 

## Общая информация

Все скрипты находятся в директории `scripts/` и могут быть запущены как напрямую, так и через основной скрипт управления `manage-gis.ps1`.

## Основной скрипт управления

### manage-gis.ps1

Основной скрипт для управления ГИС-платформой, который предоставляет единый интерфейс для всех операций.

```powershell
# Инициализация проекта
./manage-gis.ps1 init [dev|prod]

# Запуск и остановка сервисов
./manage-gis.ps1 start
./manage-gis.ps1 stop
./manage-gis.ps1 restart

# Проверка состояния
./manage-gis.ps1 status
./manage-gis.ps1 test

# Управление данными
./manage-gis.ps1 manage-ecw [list|import|register|move]
./manage-gis.ps1 setup-projections

# Обслуживание
./manage-gis.ps1 logs [service_name]
./manage-gis.ps1 backup
./manage-gis.ps1 collect-logs
./manage-gis.ps1 check-redirects
```

## Скрипты инициализации и настройки

### initialize-project.ps1

Скрипт для инициализации проекта, создания структуры директорий и настройки базовых компонентов.

**Параметры:**
- `-Environment <String>` - Окружение для инициализации (dev или prod)
- `-Force` - Принудительная инициализация (с перезаписью существующих файлов)

**Пример использования:**
```powershell
./scripts/initialize-project.ps1 -Environment dev
```

**Действия:**
1. Создает структуру директорий
2. Настраивает Docker Compose для выбранного окружения
3. Создает конфигурации NGINX
4. Создает базовый веб-интерфейс

### setup-projections.ps1

Скрипт для настройки пользовательских проекций в GeoServer.

**Параметры:**
- `-ForceRecreate` - Принудительное пересоздание директории проекций

**Пример использования:**
```powershell
./scripts/setup-projections.ps1
```

**Действия:**
1. Проверяет наличие директории для пользовательских проекций
2. Создает директорию, если она отсутствует
3. Создает пустой файл epsg.properties, если он отсутствует
4. Отображает информацию о настройке пользовательских проекций

## Скрипты управления данными

### manage-ecw.ps1

Скрипт для управления ECW файлами в Корпоративной ГИС-платформе.

**Команды:**
- `list` - Отображает список всех ECW файлов
- `import` - Импортирует ECW файл в систему
- `register` - Регистрирует файл проекции
- `move` - Перемещает ECW файл в директорию хранения

**Параметры:**
- `-FilePath <String>` - Путь к файлу для импорта/регистрации
- `-DestDir <String>` - Директория назначения (для команды move)

**Примеры использования:**
```powershell
# Список файлов
./scripts/manage-ecw.ps1 list

# Импорт ECW файла
./scripts/manage-ecw.ps1 import -FilePath C:\path\to\file.ecw

# Регистрация файла проекции
./scripts/manage-ecw.ps1 register -FilePath C:\path\to\file.prj
```

## Скрипты мониторинга и обслуживания

### check-health.ps1

Скрипт для проверки работоспособности всех компонентов ГИС-платформы.

**Параметры:**
- `-AutoFix` - Автоматическое исправление обнаруженных проблем
- `-Verbose` - Подробный вывод информации

**Пример использования:**
```powershell
./scripts/check-health.ps1 -Verbose
```

**Проверки:**
1. Статус контейнеров Docker
2. Доступность веб-сервисов
3. Наличие пользовательских проекций
4. Корректность конфигурации NGINX

### collect-container-logs.ps1

Скрипт для сбора и анализа логов из всех Docker-контейнеров.

**Параметры:**
- `-Lines <Int32>` - Количество строк логов для извлечения (по умолчанию 1000)
- `-OutputFile <String>` - Путь для сохранения результатов (по умолчанию logs/container-errors.log)
- `-IncludeInfo` - Включать информационные сообщения
- `-NoConsoleOutput` - Не выводить результаты в консоль
- `-Since <String>` - Извлекать логи с указанного времени (например, "2h" - за последние 2 часа)

**Пример использования:**
```powershell
# Базовый сбор логов
./scripts/collect-container-logs.ps1

# Расширенный сбор логов
./scripts/collect-container-logs.ps1 -Lines 2000 -IncludeInfo -Since "6h"
```

**Действия:**
1. Получает список всех запущенных контейнеров
2. Извлекает логи из каждого контейнера
3. Фильтрует логи по уровням (ERROR, WARN, INFO)
4. Удаляет дубликаты для повышения читаемости
5. Сохраняет результаты в файл и/или выводит в консоль

### check-geoserver-redirect.ps1

Скрипт для диагностики и исправления проблем с редиректами GeoServer через NGINX прокси.

**Параметры:**
- `-Test` - Только тестирование без внесения изменений
- `-Fix` - Автоматическое исправление обнаруженных проблем
- `-Verbose` - Подробный вывод процесса диагностики

**Пример использования:**
```powershell
# Тестирование конфигурации
./scripts/check-geoserver-redirect.ps1 -Test

# Автоматическое исправление проблем
./scripts/check-geoserver-redirect.ps1 -Fix
```

**Проверки:**
1. Конфигурация NGINX (location блоки, заголовки, настройки редиректов)
2. Конфигурация GeoServer (параметры CATALINA_OPTS)
3. URL маршрутизация (доступность различных URL)
4. Заголовки и редиректы (анализ заголовков HTTP)

**Действия при исправлении:**
1. Создает резервные копии всех изменяемых файлов
2. Исправляет некорректные настройки в конфигурации NGINX
3. Обновляет параметры CATALINA_OPTS для GeoServer
4. Перезапускает соответствующие сервисы для применения изменений 